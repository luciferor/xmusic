name: Build APK

on:
  push:
    branches: [main, master, dev]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: "zulu"
          java-version: "17"

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: "stable"

      - name: Install dependencies
        run: flutter pub get

      - name: Setup Node.js for keystore generation
        uses: actions/setup-node@v3
        with:
          node-version: "18"

      - name: Setup signing config
        run: |
          echo "=========================================="
          echo "é…ç½®ç­¾å"
          echo "=========================================="

          # Check if keystore secret exists
          if [ -n "${{ secrets.KEYSTORE_BASE64 }}" ]; then
            echo "âœ… ä½¿ç”¨ GitHub Secrets ä¸­çš„ç­¾åé…ç½®"
            
            # Create key.properties file from secrets
            cat > android/key.properties << EOF
          storePassword=${{ secrets.KEYSTORE_PASSWORD }}
          keyPassword=${{ secrets.KEY_PASSWORD }}
          keyAlias=${{ secrets.KEY_ALIAS }}
          storeFile=../upload-keystore.jks
          EOF
            
            # Decode and save keystore file
            echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > android/upload-keystore.jks
            echo "âœ… Release signing configured from secrets"
          else
            echo "âš ï¸ KEYSTORE_BASE64 secret not found"
            echo "ðŸ”§ è‡ªåŠ¨ç”Ÿæˆä¸´æ—¶ç­¾åå¯†é’¥ï¼ˆä»…ç”¨äºŽæµ‹è¯•ï¼‰"
            
            # Install node-forge
            npm install node-forge
            
            # Generate keystore using gen_keystore.js
            node gen_keystore.js
            
            # Move generated keystore to android folder
            mv upload-keystore.p12 android/upload-keystore.jks
            
            # Create key.properties
            cat > android/key.properties << EOF
          storePassword=123456
          keyPassword=123456
          keyAlias=upload
          storeFile=upload-keystore.jks
          EOF
            
            echo "âœ… ä¸´æ—¶ç­¾åå¯†é’¥å·²ç”Ÿæˆ"
            echo "âš ï¸ æ³¨æ„ï¼šè¿™æ˜¯ä¸´æ—¶å¯†é’¥ï¼Œä¸é€‚åˆç”Ÿäº§çŽ¯å¢ƒ"
          fi

          echo ""
          echo "ðŸ“‹ ç­¾åé…ç½®ä¿¡æ¯:"
          cat android/key.properties | sed 's/Password=.*/Password=******/'

      - name: Fix flutter_dynamic_icon issues
        run: |
          PLUGIN_DIR="${HOME}/.pub-cache/hosted/pub.dev/flutter_dynamic_icon-2.1.0/android"

          # ä¿®å¤ namespace é—®é¢˜
          if [ -f "$PLUGIN_DIR/build.gradle" ]; then
            sed -i "s/apply plugin: 'com.android.library'/apply plugin: 'com.android.library'\nandroid.namespace = 'io.github.tastelessjolt.flutterdynamicicon'/" "$PLUGIN_DIR/build.gradle"
            echo "âœ… Fixed namespace"
          fi

          # ä¿®å¤ v1 embedding é—®é¢˜ - åˆ é™¤æ•´ä¸ª registerWith æ–¹æ³•å—
          JAVA_FILE="$PLUGIN_DIR/src/main/java/io/github/tastelessjolt/flutterdynamicicon/FlutterDynamicIconPlugin.java"
          if [ -f "$JAVA_FILE" ]; then
            # ä½¿ç”¨ perl åˆ é™¤ä»Ž "public static void registerWith" åˆ°ä¸‹ä¸€ä¸ª "}" çš„æ•´ä¸ªæ–¹æ³•
            perl -i -0pe 's/public static void registerWith[^}]*\}//gs' "$JAVA_FILE"
            echo "âœ… Fixed v1 embedding"
          fi

      - name: Clean build cache
        run: |
          flutter clean
          rm -rf android/.gradle
          rm -rf android/build
          rm -rf android/app/build
          rm -rf build
          echo "âœ… Build cache cleaned"

      - name: Pre-build checks
        run: |
          echo "=========================================="
          echo "æž„å»ºå‰çŽ¯å¢ƒæ£€æŸ¥"
          echo "=========================================="

          echo ""
          echo "ðŸ“‹ Flutter ç‰ˆæœ¬:"
          flutter --version

          echo ""
          echo "ðŸ“‹ Java ç‰ˆæœ¬:"
          java -version 2>&1 | head -n 3

          echo ""
          echo "ðŸ“‹ æ£€æŸ¥ç­¾åé…ç½®:"
          if [ -f "android/key.properties" ]; then
            echo "âœ… key.properties å­˜åœ¨"
          else
            echo "âš ï¸ key.properties ä¸å­˜åœ¨ï¼Œå°†ä½¿ç”¨ debug ç­¾å"
          fi

          echo ""
          echo "ðŸ“‹ æ£€æŸ¥ Gradle é…ç½®:"
          cat android/gradle.properties | grep -v "^#" | grep -v "^$"

          echo ""
          echo "ðŸ“‹ Flutter doctor (ç®€è¦):"
          flutter doctor

      - name: Test Gradle build directly
        run: |
          echo "=========================================="
          echo "æµ‹è¯• Gradle ç›´æŽ¥æž„å»º"
          echo "=========================================="
          cd android
          ./gradlew tasks --stacktrace || echo "âš ï¸ Gradle tasks å‘½ä»¤å¤±è´¥"
          echo ""
          echo "å°è¯•æ¸…ç† Gradle ç¼“å­˜..."
          ./gradlew clean --stacktrace || echo "âš ï¸ Gradle clean å‘½ä»¤å¤±è´¥"

      - name: Build APK with verbose output
        run: |
          echo "=========================================="
          echo "å¼€å§‹æž„å»º APK"
          echo "=========================================="
          echo "å½“å‰ç›®å½•: $(pwd)"
          echo "å¼€å§‹æ—¶é—´: $(date)"

          # æ‰§è¡Œæž„å»º - ä½¿ç”¨ verbose æŸ¥çœ‹è¯¦ç»†é”™è¯¯
          echo ""
          echo "ðŸ—ï¸  æ‰§è¡Œ flutter build apk --release --verbose"
          flutter build apk --release --verbose 2>&1 | tee build.log
          BUILD_EXIT_CODE=${PIPESTATUS[0]}

          echo ""
          echo "=========================================="
          echo "æž„å»ºå‘½ä»¤é€€å‡ºç : $BUILD_EXIT_CODE"
          echo "ç»“æŸæ—¶é—´: $(date)"
          echo "=========================================="

          # ç«‹å³æ£€æŸ¥ build ç›®å½•æ˜¯å¦è¢«åˆ›å»º
          echo ""
          echo "ðŸ“ æ£€æŸ¥ build ç›®å½•æ˜¯å¦å­˜åœ¨..."
          if [ -d "build" ]; then
            echo "âœ… build ç›®å½•å­˜åœ¨"
            echo "build ç›®å½•å¤§å°: $(du -sh build 2>/dev/null || echo 'unknown')"
          else
            echo "âŒ build ç›®å½•ä¸å­˜åœ¨ï¼æž„å»ºå¯èƒ½åœ¨æ—©æœŸé˜¶æ®µå¤±è´¥"
            echo "æ˜¾ç¤ºæž„å»ºæ—¥å¿—çš„æœ€åŽ 100 è¡Œ:"
            tail -n 100 build.log
            exit 1
          fi

          if [ $BUILD_EXIT_CODE -ne 0 ]; then
            echo "âŒ Build failed with exit code $BUILD_EXIT_CODE"
            echo ""
            echo "ðŸ” æœç´¢ Gradle é”™è¯¯ä¿¡æ¯..."
            grep -i "FAILURE\|error:\|exception\|failed" build.log | tail -n 50 || echo "æœªæ‰¾åˆ°æ˜Žæ˜¾é”™è¯¯æ ‡è®°"
            echo ""
            echo "ðŸ“‹ Gradle ä»»åŠ¡æ‰§è¡Œæƒ…å†µ:"
            grep "^>" build.log | tail -n 20 || echo "æœªæ‰¾åˆ°ä»»åŠ¡ä¿¡æ¯"
            echo ""
            echo "ðŸ“‹ æž„å»ºæ—¥å¿—æœ€åŽ 100 è¡Œ:"
            tail -n 100 build.log
            exit 1
          fi

          # æ£€æŸ¥ APK æ˜¯å¦çœŸçš„ç”Ÿæˆäº†
          echo ""
          echo "ðŸ” éªŒè¯ APK æ–‡ä»¶æ˜¯å¦ç”Ÿæˆ..."
          if [ -f "build/app/outputs/flutter-apk/app-release.apk" ]; then
            echo "âœ… æ‰¾åˆ° APK: build/app/outputs/flutter-apk/app-release.apk"
            ls -lh build/app/outputs/flutter-apk/app-release.apk
          elif [ -f "build/app/outputs/apk/release/app-release.apk" ]; then
            echo "âœ… æ‰¾åˆ° APK: build/app/outputs/apk/release/app-release.apk"
            ls -lh build/app/outputs/apk/release/app-release.apk
          else
            echo "âŒ æž„å»ºå‘½ä»¤æˆåŠŸä½†æœªæ‰¾åˆ° APK æ–‡ä»¶ï¼"
            echo ""
            echo "æ£€æŸ¥ build ç›®å½•å†…å®¹:"
            find build -type f | head -n 30
            echo ""
            echo "æ£€æŸ¥æž„å»ºæ—¥å¿—ä¸­çš„é”™è¯¯..."
            grep -i "error\|failed\|exception" build.log | tail -n 30 || echo "æœªæ‰¾åˆ°æ˜Žæ˜¾é”™è¯¯"
            echo ""
            echo "æž„å»ºæ—¥å¿—æœ€åŽ 50 è¡Œ:"
            tail -n 50 build.log
            exit 1
          fi

      - name: List build outputs
        if: always()
        run: |
          echo "=========================================="
          echo "æ£€æŸ¥æž„å»ºç›®å½•ç»“æž„"
          echo "=========================================="

          echo ""
          echo "ðŸ“ build/ ç›®å½•:"
          ls -la build/ 2>/dev/null || echo "âŒ build/ ç›®å½•ä¸å­˜åœ¨"

          echo ""
          echo "ðŸ“ build/app/ ç›®å½•:"
          ls -la build/app/ 2>/dev/null || echo "âŒ build/app/ ç›®å½•ä¸å­˜åœ¨"

          echo ""
          echo "ðŸ“ build/app/outputs/ ç›®å½•:"
          ls -la build/app/outputs/ 2>/dev/null || echo "âŒ build/app/outputs/ ç›®å½•ä¸å­˜åœ¨"

          echo ""
          echo "ðŸ“ build/app/outputs/flutter-apk/ ç›®å½•:"
          ls -la build/app/outputs/flutter-apk/ 2>/dev/null || echo "âŒ build/app/outputs/flutter-apk/ ç›®å½•ä¸å­˜åœ¨"

          echo ""
          echo "ðŸ“ build/app/outputs/apk/release/ ç›®å½•:"
          ls -la build/app/outputs/apk/release/ 2>/dev/null || echo "âŒ build/app/outputs/apk/release/ ç›®å½•ä¸å­˜åœ¨"

          echo ""
          echo "ðŸ” æœç´¢æ‰€æœ‰ APK æ–‡ä»¶:"
          find build -name "*.apk" -type f -exec ls -lh {} \; 2>/dev/null || echo "âŒ æœªæ‰¾åˆ°ä»»ä½• APK æ–‡ä»¶"

          echo ""
          echo "ðŸ“‹ å®Œæ•´ build ç›®å½•æ ‘:"
          find build -type f 2>/dev/null | head -n 50 || echo "build ç›®å½•ä¸ºç©º"

      - name: Extract APK information
        if: success()
        run: |
          echo "=========================================="
          echo "ðŸ“± APK ä¿¡æ¯æå–"
          echo "=========================================="

          APK_PATH=""
          if [ -f "build/app/outputs/flutter-apk/app-release.apk" ]; then
            APK_PATH="build/app/outputs/flutter-apk/app-release.apk"
          elif [ -f "build/app/outputs/apk/release/app-release.apk" ]; then
            APK_PATH="build/app/outputs/apk/release/app-release.apk"
          fi

          if [ -n "$APK_PATH" ]; then
            echo "APK æ–‡ä»¶è·¯å¾„: $APK_PATH"
            echo ""
            
            # æ–‡ä»¶ä¿¡æ¯
            echo "ðŸ“¦ æ–‡ä»¶ä¿¡æ¯:"
            ls -lh "$APK_PATH"
            FILE_SIZE=$(du -h "$APK_PATH" | cut -f1)
            echo "æ–‡ä»¶å¤§å°: $FILE_SIZE"
            
            # ä½¿ç”¨ aapt æå– APK ä¿¡æ¯
            echo ""
            echo "ðŸ“‹ åº”ç”¨ä¿¡æ¯:"
            
            # æå–åŒ…å
            PACKAGE_NAME=$(aapt dump badging "$APK_PATH" | grep "package:" | sed "s/.*name='\([^']*\)'.*/\1/")
            echo "Bundle ID (Package Name): $PACKAGE_NAME"
            
            # æå–ç‰ˆæœ¬ä¿¡æ¯
            VERSION_CODE=$(aapt dump badging "$APK_PATH" | grep "versionCode=" | sed "s/.*versionCode='\([^']*\)'.*/\1/")
            VERSION_NAME=$(aapt dump badging "$APK_PATH" | grep "versionName=" | sed "s/.*versionName='\([^']*\)'.*/\1/")
            echo "Version Code: $VERSION_CODE"
            echo "Version Name: $VERSION_NAME"
            
            # æå–åº”ç”¨åç§°
            APP_LABEL=$(aapt dump badging "$APK_PATH" | grep "application-label:" | sed "s/.*application-label:'\([^']*\)'.*/\1/")
            echo "åº”ç”¨åç§°: $APP_LABEL"
            
            # æå– SDK ç‰ˆæœ¬
            MIN_SDK=$(aapt dump badging "$APK_PATH" | grep "sdkVersion:" | sed "s/.*sdkVersion:'\([^']*\)'.*/\1/")
            TARGET_SDK=$(aapt dump badging "$APK_PATH" | grep "targetSdkVersion:" | sed "s/.*targetSdkVersion:'\([^']*\)'.*/\1/")
            echo "Min SDK Version: $MIN_SDK"
            echo "Target SDK Version: $TARGET_SDK"
            
            # æå–æƒé™
            echo ""
            echo "ðŸ“‹ åº”ç”¨æƒé™:"
            aapt dump badging "$APK_PATH" | grep "uses-permission:" | sed "s/.*name='\([^']*\)'.*/  - \1/" | head -n 20
            
            # æå–ç­¾åä¿¡æ¯
            echo ""
            echo "ðŸ” ç­¾åä¿¡æ¯:"
            jarsigner -verify -verbose -certs "$APK_PATH" 2>&1 | grep -A 3 "Signer #1:" || echo "æ— æ³•æå–ç­¾åä¿¡æ¯"
            
            # è®¡ç®—æ–‡ä»¶å“ˆå¸Œ
            echo ""
            echo "ðŸ”‘ æ–‡ä»¶å“ˆå¸Œ:"
            echo "MD5: $(md5sum "$APK_PATH" | cut -d' ' -f1)"
            echo "SHA256: $(sha256sum "$APK_PATH" | cut -d' ' -f1)"
            
            # ä¿å­˜ä¿¡æ¯åˆ°æ–‡ä»¶
            cat > apk-info.txt << EOF
          ========================================
          APK æž„å»ºä¿¡æ¯
          ========================================

          æž„å»ºæ—¶é—´: $(date)
          æž„å»ºåˆ†æ”¯: ${{ github.ref_name }}
          æäº¤å“ˆå¸Œ: ${{ github.sha }}

          æ–‡ä»¶ä¿¡æ¯:
          - è·¯å¾„: $APK_PATH
          - å¤§å°: $FILE_SIZE

          åº”ç”¨ä¿¡æ¯:
          - Bundle ID: $PACKAGE_NAME
          - ç‰ˆæœ¬å·: $VERSION_NAME ($VERSION_CODE)
          - åº”ç”¨åç§°: $APP_LABEL
          - Min SDK: $MIN_SDK
          - Target SDK: $TARGET_SDK

          æ–‡ä»¶å“ˆå¸Œ:
          - MD5: $(md5sum "$APK_PATH" | cut -d' ' -f1)
          - SHA256: $(sha256sum "$APK_PATH" | cut -d' ' -f1)

          ä¸‹è½½é“¾æŽ¥:
          https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}

          ========================================
          EOF
            
            echo ""
            echo "âœ… APK ä¿¡æ¯å·²ä¿å­˜åˆ° apk-info.txt"
            cat apk-info.txt
          else
            echo "âŒ æœªæ‰¾åˆ° APK æ–‡ä»¶"
          fi

      - name: Upload build log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-log
          path: build.log
          retention-days: 7

      - name: Upload APK info
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: apk-info
          path: apk-info.txt
          retention-days: 30

      - name: Upload APK
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: app-release
          path: |
            build/app/outputs/flutter-apk/app-release.apk
            build/app/outputs/apk/release/app-release.apk
            build/app/outputs/apk/release/*.apk
          retention-days: 30

      - name: Create Release Summary
        if: success()
        run: |
          echo "## ðŸŽ‰ APK æž„å»ºæˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“± åº”ç”¨ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          APK_PATH=""
          if [ -f "build/app/outputs/flutter-apk/app-release.apk" ]; then
            APK_PATH="build/app/outputs/flutter-apk/app-release.apk"
          elif [ -f "build/app/outputs/apk/release/app-release.apk" ]; then
            APK_PATH="build/app/outputs/apk/release/app-release.apk"
          fi

          if [ -n "$APK_PATH" ]; then
            PACKAGE_NAME=$(aapt dump badging "$APK_PATH" | grep "package:" | sed "s/.*name='\([^']*\)'.*/\1/")
            VERSION_NAME=$(aapt dump badging "$APK_PATH" | grep "versionName=" | sed "s/.*versionName='\([^']*\)'.*/\1/")
            FILE_SIZE=$(du -h "$APK_PATH" | cut -f1)
            
            echo "| é¡¹ç›® | å€¼ |" >> $GITHUB_STEP_SUMMARY
            echo "|------|-----|" >> $GITHUB_STEP_SUMMARY
            echo "| **Bundle ID** | \`$PACKAGE_NAME\` |" >> $GITHUB_STEP_SUMMARY
            echo "| **ç‰ˆæœ¬** | \`$VERSION_NAME\` |" >> $GITHUB_STEP_SUMMARY
            echo "| **æ–‡ä»¶å¤§å°** | $FILE_SIZE |" >> $GITHUB_STEP_SUMMARY
            echo "| **æž„å»ºæ—¶é—´** | $(date) |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ“¥ ä¸‹è½½" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "åœ¨ [Actions Artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) é¡µé¢ä¸‹è½½ APK æ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
          fi
