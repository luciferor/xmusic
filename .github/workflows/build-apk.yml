name: Build APK

on:
  push:
    branches: [main, master, dev]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: "zulu"
          java-version: "17"

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: "stable"

      - name: Install dependencies
        run: flutter pub get

      - name: Setup signing config
        run: |
          # Check if keystore secret exists
          if [ -n "${{ secrets.KEYSTORE_BASE64 }}" ]; then
            echo "âœ… Setting up release signing configuration"
            
            # Create key.properties file from secrets
            cat > android/key.properties << EOF
          storePassword=${{ secrets.KEYSTORE_PASSWORD }}
          keyPassword=${{ secrets.KEY_PASSWORD }}
          keyAlias=${{ secrets.KEY_ALIAS }}
          storeFile=../upload-keystore.jks
          EOF
            
            # Decode and save keystore file
            echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 -d > android/upload-keystore.jks
            echo "âœ… Release signing configured"
          else
            echo "âš ï¸ KEYSTORE_BASE64 secret not found"
            echo "âš ï¸ Build will use debug signing (not suitable for production)"
            echo "âš ï¸ See .github/SIGNING_SETUP.md for setup instructions"
          fi

      - name: Fix flutter_dynamic_icon issues
        run: |
          PLUGIN_DIR="${HOME}/.pub-cache/hosted/pub.dev/flutter_dynamic_icon-2.1.0/android"

          # ä¿®å¤ namespace é—®é¢˜
          if [ -f "$PLUGIN_DIR/build.gradle" ]; then
            sed -i "s/apply plugin: 'com.android.library'/apply plugin: 'com.android.library'\nandroid.namespace = 'io.github.tastelessjolt.flutterdynamicicon'/" "$PLUGIN_DIR/build.gradle"
            echo "âœ… Fixed namespace"
          fi

          # ä¿®å¤ v1 embedding é—®é¢˜ - åˆ é™¤æ•´ä¸ª registerWith æ–¹æ³•å—
          JAVA_FILE="$PLUGIN_DIR/src/main/java/io/github/tastelessjolt/flutterdynamicicon/FlutterDynamicIconPlugin.java"
          if [ -f "$JAVA_FILE" ]; then
            # ä½¿ç”¨ perl åˆ é™¤ä»Ž "public static void registerWith" åˆ°ä¸‹ä¸€ä¸ª "}" çš„æ•´ä¸ªæ–¹æ³•
            perl -i -0pe 's/public static void registerWith[^}]*\}//gs' "$JAVA_FILE"
            echo "âœ… Fixed v1 embedding"
          fi

      - name: Clean build cache
        run: |
          flutter clean
          rm -rf android/.gradle
          rm -rf android/build
          rm -rf android/app/build
          rm -rf build
          echo "âœ… Build cache cleaned"

      - name: Pre-build checks
        run: |
          echo "=========================================="
          echo "æž„å»ºå‰çŽ¯å¢ƒæ£€æŸ¥"
          echo "=========================================="

          echo ""
          echo "ðŸ“‹ Flutter ç‰ˆæœ¬:"
          flutter --version

          echo ""
          echo "ðŸ“‹ Java ç‰ˆæœ¬:"
          java -version

          echo ""
          echo "ðŸ“‹ Android SDK è·¯å¾„:"
          echo $ANDROID_SDK_ROOT

          echo ""
          echo "ðŸ“‹ æ£€æŸ¥ Android é…ç½®:"
          ls -la android/

          echo ""
          echo "ðŸ“‹ æ£€æŸ¥ build.gradle:"
          cat android/app/build.gradle | grep -A 5 "buildTypes"

          echo ""
          echo "ðŸ“‹ æ£€æŸ¥ç­¾åé…ç½®:"
          if [ -f "android/key.properties" ]; then
            echo "âœ… key.properties å­˜åœ¨"
            cat android/key.properties | sed 's/Password=.*/Password=***/' 
          else
            echo "âš ï¸ key.properties ä¸å­˜åœ¨ï¼Œå°†ä½¿ç”¨ debug ç­¾å"
          fi

          echo ""
          echo "ðŸ“‹ Flutter doctor:"
          flutter doctor -v

      - name: Build APK with verbose output
        run: |
          set -e
          echo "=========================================="
          echo "å¼€å§‹æž„å»º APK"
          echo "=========================================="
          echo "å½“å‰ç›®å½•: $(pwd)"
          echo "å¼€å§‹æ—¶é—´: $(date)"

          # æ‰§è¡Œæž„å»º
          echo ""
          echo "ðŸ—ï¸  æ‰§è¡Œ flutter build apk --release --verbose"
          flutter build apk --release --verbose 2>&1 | tee build.log
          BUILD_EXIT_CODE=${PIPESTATUS[0]}

          echo ""
          echo "=========================================="
          echo "æž„å»ºå‘½ä»¤é€€å‡ºç : $BUILD_EXIT_CODE"
          echo "ç»“æŸæ—¶é—´: $(date)"
          echo "=========================================="

          # ç«‹å³æ£€æŸ¥ build ç›®å½•æ˜¯å¦è¢«åˆ›å»º
          echo ""
          echo "ðŸ“ æ£€æŸ¥ build ç›®å½•æ˜¯å¦å­˜åœ¨..."
          if [ -d "build" ]; then
            echo "âœ… build ç›®å½•å­˜åœ¨"
            echo "build ç›®å½•å¤§å°: $(du -sh build 2>/dev/null || echo 'unknown')"
          else
            echo "âŒ build ç›®å½•ä¸å­˜åœ¨ï¼æž„å»ºå¯èƒ½åœ¨æ—©æœŸé˜¶æ®µå¤±è´¥"
            echo "æ˜¾ç¤ºæž„å»ºæ—¥å¿—çš„æœ€åŽ 100 è¡Œ:"
            tail -n 100 build.log
            exit 1
          fi

          if [ $BUILD_EXIT_CODE -ne 0 ]; then
            echo "âŒ Build failed with exit code $BUILD_EXIT_CODE"
            echo "Last 100 lines of output:"
            tail -n 100 build.log
            exit 1
          fi

          # æ£€æŸ¥ APK æ˜¯å¦çœŸçš„ç”Ÿæˆäº†
          echo ""
          echo "ðŸ” éªŒè¯ APK æ–‡ä»¶æ˜¯å¦ç”Ÿæˆ..."
          if [ -f "build/app/outputs/flutter-apk/app-release.apk" ]; then
            echo "âœ… æ‰¾åˆ° APK: build/app/outputs/flutter-apk/app-release.apk"
            ls -lh build/app/outputs/flutter-apk/app-release.apk
          elif [ -f "build/app/outputs/apk/release/app-release.apk" ]; then
            echo "âœ… æ‰¾åˆ° APK: build/app/outputs/apk/release/app-release.apk"
            ls -lh build/app/outputs/apk/release/app-release.apk
          else
            echo "âŒ æž„å»ºå‘½ä»¤æˆåŠŸä½†æœªæ‰¾åˆ° APK æ–‡ä»¶ï¼"
            echo ""
            echo "æ£€æŸ¥ build ç›®å½•å†…å®¹:"
            find build -type f | head -n 30
            echo ""
            echo "æ£€æŸ¥æž„å»ºæ—¥å¿—ä¸­çš„é”™è¯¯..."
            grep -i "error\|failed\|exception" build.log | tail -n 30 || echo "æœªæ‰¾åˆ°æ˜Žæ˜¾é”™è¯¯"
            echo ""
            echo "æž„å»ºæ—¥å¿—æœ€åŽ 50 è¡Œ:"
            tail -n 50 build.log
            exit 1
          fi

      - name: List build outputs
        if: always()
        run: |
          echo "=========================================="
          echo "æ£€æŸ¥æž„å»ºç›®å½•ç»“æž„"
          echo "=========================================="

          echo ""
          echo "ðŸ“ build/ ç›®å½•:"
          ls -la build/ 2>/dev/null || echo "âŒ build/ ç›®å½•ä¸å­˜åœ¨"

          echo ""
          echo "ðŸ“ build/app/ ç›®å½•:"
          ls -la build/app/ 2>/dev/null || echo "âŒ build/app/ ç›®å½•ä¸å­˜åœ¨"

          echo ""
          echo "ðŸ“ build/app/outputs/ ç›®å½•:"
          ls -la build/app/outputs/ 2>/dev/null || echo "âŒ build/app/outputs/ ç›®å½•ä¸å­˜åœ¨"

          echo ""
          echo "ðŸ“ build/app/outputs/flutter-apk/ ç›®å½•:"
          ls -la build/app/outputs/flutter-apk/ 2>/dev/null || echo "âŒ build/app/outputs/flutter-apk/ ç›®å½•ä¸å­˜åœ¨"

          echo ""
          echo "ðŸ“ build/app/outputs/apk/release/ ç›®å½•:"
          ls -la build/app/outputs/apk/release/ 2>/dev/null || echo "âŒ build/app/outputs/apk/release/ ç›®å½•ä¸å­˜åœ¨"

          echo ""
          echo "ðŸ” æœç´¢æ‰€æœ‰ APK æ–‡ä»¶:"
          find build -name "*.apk" -type f -exec ls -lh {} \; 2>/dev/null || echo "âŒ æœªæ‰¾åˆ°ä»»ä½• APK æ–‡ä»¶"

          echo ""
          echo "ðŸ“‹ å®Œæ•´ build ç›®å½•æ ‘:"
          find build -type f 2>/dev/null | head -n 50 || echo "build ç›®å½•ä¸ºç©º"

      - name: Upload build log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-log
          path: build.log
          retention-days: 7

      - name: Upload APK
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: app-release
          path: |
            build/app/outputs/flutter-apk/app-release.apk
            build/app/outputs/apk/release/app-release.apk
            build/app/outputs/apk/release/*.apk
