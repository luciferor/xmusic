name: Build APK (Simplified)

on:
  push:
    branches: [main, master, dev]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: "zulu"
          java-version: "17"

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: "stable"

      - name: Install dependencies
        run: flutter pub get

      - name: Setup signing (use debug signing)
        run: |
          echo "âš ï¸ ä½¿ç”¨ debug ç­¾åï¼ˆé€‚åˆæµ‹è¯•ï¼‰"
          echo "å¦‚éœ€ release ç­¾åï¼Œè¯·é…ç½® GitHub Secrets"

      - name: Fix flutter_dynamic_icon
        run: |
          PLUGIN_DIR="${HOME}/.pub-cache/hosted/pub.dev/flutter_dynamic_icon-2.1.0/android"
          if [ -f "$PLUGIN_DIR/build.gradle" ]; then
            sed -i "s/apply plugin: 'com.android.library'/apply plugin: 'com.android.library'\nandroid.namespace = 'io.github.tastelessjolt.flutterdynamicicon'/" "$PLUGIN_DIR/build.gradle"
          fi
          JAVA_FILE="$PLUGIN_DIR/src/main/java/io/github/tastelessjolt/flutterdynamicicon/FlutterDynamicIconPlugin.java"
          if [ -f "$JAVA_FILE" ]; then
            perl -i -0pe 's/public static void registerWith[^}]*\}//gs' "$JAVA_FILE"
          fi

      - name: Build APK
        run: |
          flutter clean
          flutter build apk --debug

          # æ£€æŸ¥ APK
          if [ -f "build/app/outputs/flutter-apk/app-debug.apk" ]; then
            echo "âœ… APK æž„å»ºæˆåŠŸ"
            ls -lh build/app/outputs/flutter-apk/app-debug.apk
          else
            echo "âŒ APK æž„å»ºå¤±è´¥"
            exit 1
          fi

      - name: Extract APK info
        if: success()
        run: |
          APK_PATH="build/app/outputs/flutter-apk/app-debug.apk"

          if [ -f "$APK_PATH" ]; then
            echo "=========================================="
            echo "ðŸ“± APK ä¿¡æ¯"
            echo "=========================================="
            
            FILE_SIZE=$(du -h "$APK_PATH" | cut -f1)
            PACKAGE_NAME=$(aapt dump badging "$APK_PATH" | grep "package:" | sed "s/.*name='\([^']*\)'.*/\1/")
            VERSION_NAME=$(aapt dump badging "$APK_PATH" | grep "versionName=" | sed "s/.*versionName='\([^']*\)'.*/\1/")
            VERSION_CODE=$(aapt dump badging "$APK_PATH" | grep "versionCode=" | sed "s/.*versionCode='\([^']*\)'.*/\1/")
            APP_LABEL=$(aapt dump badging "$APK_PATH" | grep "application-label:" | sed "s/.*application-label:'\([^']*\)'.*/\1/")
            
            echo "Bundle ID: $PACKAGE_NAME"
            echo "ç‰ˆæœ¬: $VERSION_NAME ($VERSION_CODE)"
            echo "åº”ç”¨åç§°: $APP_LABEL"
            echo "æ–‡ä»¶å¤§å°: $FILE_SIZE"
            echo "æ–‡ä»¶è·¯å¾„: $APK_PATH"
            
            # ä¿å­˜ä¿¡æ¯
            cat > apk-info.txt << 'EOFMARKER'
          APK æž„å»ºä¿¡æ¯
          ==========================================
          EOFMARKER
            echo "Bundle ID: $PACKAGE_NAME" >> apk-info.txt
            echo "ç‰ˆæœ¬: $VERSION_NAME ($VERSION_CODE)" >> apk-info.txt
            echo "åº”ç”¨åç§°: $APP_LABEL" >> apk-info.txt
            echo "æ–‡ä»¶å¤§å°: $FILE_SIZE" >> apk-info.txt
            echo "æ–‡ä»¶è·¯å¾„: $APK_PATH" >> apk-info.txt
            echo "æž„å»ºæ—¶é—´: $(date)" >> apk-info.txt
            echo "ä¸‹è½½é“¾æŽ¥: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> apk-info.txt
            echo "==========================================" >> apk-info.txt
            
            cat apk-info.txt
          fi

      - name: Upload APK
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: app-debug
          path: build/app/outputs/flutter-apk/app-debug.apk
          retention-days: 30

      - name: Upload APK info
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: apk-info
          path: apk-info.txt
          retention-days: 30

      - name: Create Summary
        if: success()
        run: |
          APK_PATH="build/app/outputs/flutter-apk/app-debug.apk"

          if [ -f "$APK_PATH" ]; then
            PACKAGE_NAME=$(aapt dump badging "$APK_PATH" | grep "package:" | sed "s/.*name='\([^']*\)'.*/\1/")
            VERSION_NAME=$(aapt dump badging "$APK_PATH" | grep "versionName=" | sed "s/.*versionName='\([^']*\)'.*/\1/")
            FILE_SIZE=$(du -h "$APK_PATH" | cut -f1)
            
            echo "## ðŸŽ‰ APK æž„å»ºæˆåŠŸ" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| é¡¹ç›® | å€¼ |" >> $GITHUB_STEP_SUMMARY
            echo "|------|-----|" >> $GITHUB_STEP_SUMMARY
            echo "| **Bundle ID** | \`$PACKAGE_NAME\` |" >> $GITHUB_STEP_SUMMARY
            echo "| **ç‰ˆæœ¬** | \`$VERSION_NAME\` |" >> $GITHUB_STEP_SUMMARY
            echo "| **æ–‡ä»¶å¤§å°** | $FILE_SIZE |" >> $GITHUB_STEP_SUMMARY
            echo "| **æž„å»ºæ—¶é—´** | $(date) |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ“¥ ä¸‹è½½" >> $GITHUB_STEP_SUMMARY
            echo "åœ¨ [Artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) ä¸‹è½½ APK" >> $GITHUB_STEP_SUMMARY
          fi
